<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cadastro de Clientes</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
	integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
	crossorigin="anonymous">
</head>
<body th:class="${theme}">
	<form onsubmit="event.preventDefault(); enviarCadastro();">
		<div class="form-row">
			<div class="form-group col-md-6">
				<label for="inputNome">Nome</label> <input type="text"
					class="form-control" id="inputNome" placeholder="nome">
			</div>
			<div class="form-group col-md-6">
				<label for="inputCpf">CPF</label> <input type="text"
					class="form-control" id="inputCpf" placeholder="CPF">
			</div>
			<div class="form-group col-md-6">
				<label for="inputData">Data de Nascimento</label> <input type="Date"
					class="form-control" id="inputData"
					placeholder="Data de Nascimento">
			</div>
		</div>

		<!-- CEP e Botão Buscar Endereço -->
		<div class="form-row">
			<div class="form-group col-md-6">
				<label for="inputCEP">CEP</label> <input type="text"
					class="form-control" id="inputCEP" placeholder="Digite o CEP">
			</div>
			<div class="form-group col-md-6 d-flex align-items-end">
				<button type="button" class="btn btn-secondary"
					onclick="buscarEndereco()">Buscar Endereço</button>
			</div>
		</div>

		<!-- Campos de Endereço -->
		<div class="form-row">
			<div class="form-group col-md-6">
				<label for="inputEndereco">Endereço</label> <input type="text"
					class="form-control" id="inputEndereco"
					placeholder="Rua dos Bobos, nº 0" readonly>
			</div>
			<div class="form-group col-md-6">
				<label for="inputNumero">Número</label> <input type="text"
					class="form-control" id="inputNumero" placeholder="Número">
			</div>
		</div>


		<!-- Numero e Bairro lado a lado -->
		<div class="form-row">
			<div class="form-group col-md-6">
				<label for="inputBairro">Bairro</label> <input type="text"
					class="form-control" id="inputBairro" placeholder="Bairro">
			</div>
			<div class="form-group col-md-6">
				<label for="inputComplemento">Complemento</label> <input type="text"
					class="form-control" id="inputComplemento"
					placeholder="Apartamento, hotel, casa, etc.">
			</div>
		</div>
		<div class="form-row">
			<div class="form-group col-md-6">
				<label for="inputLocalidade">Cidade</label> <input type="text"
					class="form-control" id="inputLocalidade" readonly>
			</div>
			<div class="form-group col-md-4">
				<label for="inputUf">Estado</label> <input type="text"
					class="form-control" id="inputUf" readonly>
			</div>
		</div>

		<div class="form-group col-md-4">
			<label for="inputCategoria">Categoria 1 Comum | 2  Super | 3 Premium 
			 </label> <select id="inputCategoria" class="form-control">
				<option selected></option>
				<option>1</option>
				<option>2</option>
				<option>3</option>
			</select>
		</div>


		<button type="submit" class="btn btn-primary">Cadastrar</button>
		<button type="button" class="btn btn-primary" onclick="window.history.back()">Voltar</button>
	</form>
	<script>
function buscarEndereco() {
    var cep = document.getElementById("inputCEP").value;
    if (cep.length === 8) { 
        fetch(`http://localhost:8080/buscar-endereco/${cep}`)
            .then(response => response.json())
            .then(data => {
            	console.log(data);
                if (data) {
                    document.getElementById("inputEndereco").value = data.logradouro;
                    document.getElementById("inputLocalidade").value = data.localidade;
                    document.getElementById("inputUf").value = data.uf;
                    document.getElementById("inputBairro").value = data.bairro;
                } else {
                    alert("CEP não encontrado!");
                }
            })
            .catch(error => {
                console.error("Erro ao buscar endereço:", error);
            });
    } else {
        alert("CEP inválido.");
    }
}




function enviarCadastro() {
    var cliente = {
        nome: document.getElementById("inputNome").value,
        cpf: document.getElementById("inputCpf").value,
        dataNascimento: document.getElementById("inputData").value,
        categoria: document.getElementById("inputCategoria").value,
        endereco: {
            logradouro: document.getElementById("inputEndereco").value,
            numero: document.getElementById("inputNumero").value,
            bairro: document.getElementById("inputBairro").value,
            localidade: document.getElementById("inputLocalidade").value,
            complemento: document.getElementById("inputComplemento").value,
            uf: document.getElementById("inputUf").value,
            cep: document.getElementById("inputCEP").value
        }
    };
    if (!validarFormulario()) {
        return;
    }
    // Enviar os dados para o servidor
    fetch('http://localhost:8080/cliente/addCliente', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(cliente)
    })
    .then(response => response.json())
    .then(data => {
        alert("Cliente cadastrado com sucesso!");
        console.log(data); // Verifica a resposta do servidor
    })
    .catch(error => {
        console.error("Erro ao cadastrar cliente:", error);
    });
} 


function validarIdade() {
    const dataNascimento = document.getElementById('inputData').value;  // Pega a data de nascimento do campo de entrada
    const dataNascimentoFormatada = new Date(dataNascimento);
    
    // Verifica se a data de nascimento é válida
    if (isNaN(dataNascimentoFormatada.getTime())) {
        alert("Data de nascimento inválida. O formato deve ser dd/MM/yyyy.");
        return false;
    }

    // Calcula a idade
    const hoje = new Date();
    let idade = hoje.getFullYear() - dataNascimentoFormatada.getFullYear();
    const mes = hoje.getMonth() - dataNascimentoFormatada.getMonth();
    if (mes < 0 || (mes === 0 && hoje.getDate() < dataNascimentoFormatada.getDate())) {
        idade--;
    }

    // Verifica se o cliente tem ao menos 18 anos
    if (idade < 18) {
        alert("O cliente deve ter ao menos 18 anos.");
        return false;
    }
    
    // Se a idade for válida
    return true;
}
function validarFormulario() {
    var nome = document.getElementById("inputNome").value;
    var cpf = document.getElementById("inputCpf").value;

    if (nome.length < 2 || nome.length > 100) {
        alert("O nome deve ter entre 2 e 100 caracteres.");
        return false;
    }

    if (!validarCpf(cpf)) {
        alert("CPF inválido.");
        return false;
    }
    
	if(!validarIdade()) {
		return false;
	}

    return true;
}

function validarCpf(cpf) {
    // Remove qualquer caractere não numérico (como pontos e hífens)
    cpf = cpf.replace(/[^\d]+/g, '');

    // Verifica se o CPF tem exatamente 11 dígitos
    if (cpf.length !== 11 || /^[0-9]+$/.test(cpf) === false) {
        return false;
    }

    // Validação do CPF com base nos dois dígitos verificadores
    let soma = 0;
    let resto;

    // Primeiro dígito verificador
    for (let i = 1; i <= 9; i++) {
        soma += parseInt(cpf.charAt(i - 1)) * (11 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) {
        resto = 0;
    }
    if (resto !== parseInt(cpf.charAt(9))) {
        return false;
    }

    soma = 0;
    // Segundo dígito verificador
    for (let i = 1; i <= 10; i++) {
        soma += parseInt(cpf.charAt(i - 1)) * (12 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) {
        resto = 0;
    }
    if (resto !== parseInt(cpf.charAt(10))) {
        return false;
    }

    return true;
}
</script>

</body>
</html>